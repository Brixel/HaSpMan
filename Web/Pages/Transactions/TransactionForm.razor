@using Types
@using MediatR
@using Queries.Members
@using Queries.Members.Handlers
@inject IMediator mediator;
<MudGrid>
    <MudItem xs="6">
        <MudRadioGroup @bind-SelectedOption="TransactionTypeGroup">
            @foreach (var transactionTypeGroup in Enum.GetValues<TransactionTypeGroup>())
            {
                <MudRadio Option="transactionTypeGroup">@transactionTypeGroup</MudRadio>

            }
        </MudRadioGroup>
    </MudItem>
    <MudItem xs="6">
        <MudAutocomplete T="AutocompleteMember" 
                         Label="Members" 
                         @bind-Value="Transaction.Member"
                         SearchFunc="SearchFunc" 
                         ToStringFunc="@(e => e == null ? null : e.Name)"
                         
        ></MudAutocomplete>
    </MudItem>
    <MudItem xs="3">
        <MudNumericField Label="Amount" @bind-Value="Transaction.Amount" For="@(() => Transaction.Amount)"/>
    </MudItem>
    <MudItem xs="12">
        <MudTextField T="string" Label="Description" @bind-value="Transaction.Description" For="(() => Transaction.Description)"/>
    </MudItem>
    <MudItem xs="6">
        <MudTextField T="Guid?" Label="BankAccountId" @bind-value="Transaction.BankAccountId" For="(() => Transaction.BankAccountId)"/>
    </MudItem>
    <MudItem xs="12" sm="6" md="4">
        <MudDatePicker @ref="_picker" Label="Transaction date" @bind-Date="Transaction.ReceivedDateTime"
                       AutoClose="true" MaxDate="DateTime.Now">
            <PickerActions>
                <MudButton Class="mr-auto align-self-start" OnClick="@(() => _picker.Clear())">Clear</MudButton>
            </PickerActions>
        </MudDatePicker>
    </MudItem>
    @foreach (var transactionType in Transaction.TransactionTypeAmounts)
    {
        <MudItem xs="6">
            <MudSelect Label="Select transaction type" @bind-Value="transactionType.TransactionType">
                @foreach (var item in GetScopedTransactionTypes())
                {
                    <MudSelectItem Value="@item">@item</MudSelectItem>
                }
            </MudSelect>
            <MudNumericField T="decimal" Label="Amount" @bind-Value="transactionType.Amount" ></MudNumericField>
        </MudItem>
    }
    <ValidationSummary></ValidationSummary>
</MudGrid>

@code {
    [Parameter]
    public Models.TransactionForm Transaction { get; set; } = new();

    [Parameter]
    public TransactionTypeGroup TransactionTypeGroup { get; set; }

    private AutocompleteMember? _selectedAutocompleteMember;
    

    private IReadOnlyList<TransactionType> GetScopedTransactionTypes()
    {
        if (TransactionTypeGroup == TransactionTypeGroup.Credit)
        {
            return new List<TransactionType>
            {
                TransactionType.CreditWorkshopFee,
                TransactionType.CreditDonation,
                TransactionType.CreditMemberFee,
                TransactionType.InternalBank
            };
        }
        return new List<TransactionType>
        {
            TransactionType.DebitAcquisitionConsumables,
            TransactionType.DebitAcquisitionGoodsAndServices,
            TransactionType.DebitBankCosts,
            TransactionType.DebitFixedCosts,
            TransactionType.InternalBank

        };
    }

    MudDatePicker _picker = new();

    private async Task<IEnumerable<AutocompleteMember>> SearchFunc(string searchString)
    {
        var response = await mediator.Send(new AutocompleteMembersQuery(searchString));
        return response.Members;
    }
    

}